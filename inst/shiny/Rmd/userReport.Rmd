---
title: Wallace Session `r Sys.Date()`
output: html_document
---

```{r, include=FALSE}
library(knitr)
knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knit_child(text = options$code)
})
knitr::opts_chunk$set(message = FALSE, warning = FALSE, eval = FALSE)
```

```{r, include = FALSE, eval = TRUE}

```

Please find below the R code history from your *Wallace* v1.9.9* session. 

You can reproduce your session results by running this R Markdown file in RStudio. 

Each code block is called a "chunk", and you can run them either one-by-one or all at once by choosing an option in the "Run" menu at the top-right corner of the "Source" pane in RStudio. 

For more detailed information see <http://rmarkdown.rstudio.com>).

### Package installation

Wallace uses the following R packages that must be installed and loaded before starting.
```{r}
library(spocc)
library(spThin)
library(dismo)
library(rgeos)
library(ENMeval)
library(wallace)
```

The *Wallace* session code .Rmd file is composed of a chain of module functions that are internal to *Wallace*. Each of these functions corresponds to a single module that the user ran during the session. To see the internal code for these module functions, click on the links in the .Rmd file. Users are encouraged to write custom code in the .Rmd directly to modify their analysis, and even modify the module function code to further customize. To see the source code for any module function, just type its name into the R console and press Return.

```{r}
# example:
# just type the function name and press Return to see its source code
# paste this code into a new script to edit it
occs_queryDb
```

Your analyses are below.

###########################################
Analysis for *`r "{{spName}}"`*
###########################################

```{asis}
### Obtain Occurrence Data
```

```{asis, echo = {{occsDb_knit}}, eval = {{occsDb_knit}}, include = {{occsDb_knit}}}
You searched the `r "{{occDb}}"` database for *`r "{{spName}}"`*, limited to `r {{occNum}}` records.
```

```{r, echo = {{occsDb_knit}}, include = {{occsDb_knit}}}
# query selected database for occurrence records
occs.query <- occs_queryDb(spName = "{{spName}}", occDb = "{{occDb}}", occNum = {{occNum}})
occs.{{sp}} <- occs.query$cleaned
```

```{asis, echo = {{occsUser_knit}}, eval = {{occsUser_knit}}, include = {{occsUser_knit}}}
User CSV path with occurrence data. If the CSV file is not in the current workspace, change to the correct file path (e.g. "/Users/darwin/Documents/occs.user").
```

```{r, echo = {{occsUser_knit}}}
# NOTE: provide the path to the .csv file
occs.path <- ""
# get a list of species occurrence data
occs.user <- occs_userOccs(csvPath = occs.path, csvName = "{{userOccsCsvName}}")
occs.{{sp}} <- occs.user[["{{spName}}"]]$cleaned
```

```{asis}
### Process Occurrence Data
```

```{asis, echo = {{removeByID_knit}}, eval = {{removeByID_knit}}, include = {{removeByID_knit}}}
Remove the occurrence localities by ID.
```

```{r, echo = {{removeByID_knit}}, include = {{removeByID_knit}}}
# remove the rows that match the occIDs selected
occs.{{sp}} <- poccs_removeByID(occs.{{sp}}, {{removeByID_id}})
```

```{asis, echo = {{selectByID_knit}}, eval = {{selectByID_knit}}, include = {{selectByID_knit}}}
The following code recreates the polygon used to select occurrences to keep in the analysis.
```

```{r, echo = {{selectByID_knit}}, include = {{selectByID_knit}}}
occs.{{sp}} <- poccs_selectOccs(occs.{{sp}}, "{{selectByID_xy}}", "{{selectByID_id}}")
```

``` {asis, echo = {{worldclim_knit}}, eval = {{worldclim_knit}}, include = {{worldclim_knit}}}
Using WorldClim (http://www.worldclim.org/) bioclimatic dataset at resolution of `r {{wcRes}}` arcmin.
```

```{r, echo = {{worldclim_knit}}, include = {{worldclim_knit}}}
envs.{{sp}} <- envs_worldclim({{wcRes}}, {{bcSel}}, {{mapCntr}}, {{wcBrick}})
occs.{{sp}}.xy <- occs.{{sp}}[c('longitude', 'latitude')]
occs.{{sp}}.vals <- as.data.frame(raster::extract(envs.{{sp}}, occs.{{sp}}.xy))
# remove occurrence records with NA environmental values
occs.{{sp}} <- remEnvsValsNA(occs.{{sp}}, occs.{{sp}}.vals)
# also remove variable value rows with NA environmental values
occs.{{sp}}.vals <- na.omit(occs.{{sp}}.vals)
# add columns for env variable values for each occurrence record
occs.{{sp}} <- cbind(occs.{{sp}}, occs.{{sp}}.vals)
```

```{asis, echo = {{bgExtent_knit}}, eval = {{bgExtent_knit}}, include = {{bgExtent_knit}}}
### Process Environmental Data
Background selection technique chosen as "`r '{{bgSel}}'`".
```

```{r, echo = {{bgExtent_knit}}, include = {{bgExtent_knit}}}
bgExt.{{sp}} <- c4_bgExtent(occs.{{sp}}, "{{bgSel}}", {{bgBuf}})
```

```{asis, echo = {{bgMskSamplePts_knit}}, eval = {{bgMskSamplePts_knit}}, include = {{bgMskSamplePts_knit}}}
### Process Environmental Data
Environmental rasters masked to background extent, and *n* = `r {{bgPtsNum}}` background points sampled over this extent.
```

```{r, echo = {{bgMskSamplePts_knit}}, include = {{bgMskSamplePts_knit}}}
bgMask.{{sp}} <- c4_bgMask(occs.{{sp}}, envs.{{sp}}, bgExt.{{sp}})

bg.{{sp}} <- c4_bgSample(occs.{{sp}}, bgMask.{{sp}}, {{bgPtsNum}})
bg.{{sp}}.vals <- as.data.frame(raster::extract(bgMask.{{sp}}, bg.{{sp}}))
```

```{asis, echo = {{espace_pca_knit}}, eval = {{espace_pca_knit}}, include = {{espace_pca_knit}}}
### Environmental Space Analyses
Environmental PCA run.
```

```{r, echo = {{espace_pca_knit}}, include = {{espace_pca_knit}}}
pca.sel <- {{pcaSel}}
pca.{{sp}} <- cESpace_pca("{{espace.sp1}}", "{{espace.sp2}}", 
                          occs.{{espace.sp1}}.vals[pca.sel], 
                          occs.{{espace.sp2}}.vals[pca.sel],
                          bg.{{espace.sp1}}.vals[pca.sel], 
                          bg.{{espace.sp2}}.vals[pca.sel])
```

```{asis, echo = {{espace_occDens_knit}}, eval = {{espace_occDens_knit}}, include = {{espace_occDens_knit}}}
### Environmental Space Analyses
Occurrence density run.
```

```{r, echo = {{espace_occDens_knit}}, include = {{espace_occDens_knit}}}
occDens.{{sp}} <- cESpace_occDens("{{espace.sp1}}", "{{espace.sp2}}", pca.{{sp}})
```

```{asis, echo = {{espace_nicheOv_knit}}, eval = {{espace_nicheOv_knit}}, include = {{espace_nicheOv_knit}}}
### Environmental Space Analyses
Niche overlap run.
```

```{r, echo = {{espace_nicheOv_knit}}, include = {{espace_nicheOv_knit}}}
nicheOv.{{sp}} <- cESpace_nicheOv(occDens.{{sp}}[["{{espace.sp1}}"]], 
                                  occDens.{{sp}}[["{{espace.sp2}}"]], pca.{{sp}})
```
   
